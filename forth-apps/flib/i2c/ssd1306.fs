\ interface to 128x64 OLED
\ uses i2c

[ifndef] OLED.LARGE  1 constant OLED.LARGE  [then]  \ 0 = 128x32, 1 = 128x64

: lcd? ( -- f )  \ probe whether device exists, return true if it does
  $3C i2c-addr 0 i2c-xfer 0= ;

: lcd!c ( v -- )  \ send a command to the lcd
  $3C i2c-addr  $80 >i2c >i2c  0 i2c-xfer drop ;

\ the oled's display memory buffer is set up as 4 or 8 rows of 128 bytes
\ each byte is 8 pixels down, from b0 at the top to b7 at the bottom

1024 buffer: lcdmem

\ clear, putpixel, and display are used by the graphics.fs code

: clear ( -- )  \ clear display memory
  lcdmem 1024 0 fill ;

: putpixel ( x y -- )  \ set a pixel in display memory
  OLED.LARGE 0= if 2* 1+ then
  1 over 7 and lshift ( x y bit ) -rot
  3 rshift 7 lshift + lcdmem + cbis! ;

: display ( -- )  \ update the oled from display memory
  $B0 lcd!c  \ SET PAGE START
  $00 lcd!c  \ SETLOWCOLUMN
  $10 lcd!c  \ SETHIGHCOLUMN
  $40 lcd!c  \ SETSTARTLINE

  lcdmem  16 0 do  \ send as a number of 64-byte data messages
    $3C i2c-addr $40 >i2c 
    64 0 do  dup c@ >i2c  1+ loop
    0 i2c-xfer drop
  loop drop ;

create logo  \ 64x64 pixels
binary
  00000000000000000000000000000111 , 11100000000000000000000000000000 ,
  00000000000000000000000111111111 , 11111111100000000000000000000000 ,
  00000000000000000000111111111111 , 11111111111100000000000000000000 ,
  00000000000000000011111111111111 , 11111111111111000000000000000000 ,
  00000000000000001111111111111111 , 11111111111111110000000000000000 ,
  00000000000000011111111111000000 , 00000011111111111000000000000000 ,
  00000000000001111111110000000000 , 00000000011111111110000000000000 ,
  00000000000011111111000000000000 , 00000000000011111111000000000000 ,
  00000000000111111100000000000000 , 00000000000000111111100000000000 ,
  00000000001111111000000000000000 , 00000000000000011111110000000000 ,
  00000000011111100000000000000000 , 00000000000000000111111000000000 ,
  00000000111111000000000000000000 , 00000001100000000011111100000000 ,
  00000001111110000000000000000000 , 00000001000000000001111110000000 ,
  00000011111100000000000000000000 , 00000001000000000000111111000000 ,
  00000011111000000000000000000000 , 00000011000000000000011111000000 ,
  00000111110000000000000000000111 , 10000010000000000000001111100000 ,
  00001111110000000000000000000111 , 11000110000000000000001111110000 ,
  00001111100000000000000000001111 , 11000100000000000000000111110000 ,
  00011111000000000000000000001111 , 10000100000000000000000011111000 ,
  00011111000000000000000000001111 , 10001100011110000000000011111000 ,
  00111110000000000000000000011111 , 10001000011111000000000001111100 ,
  00111110000000000000000000011111 , 00001000111111000000000001111100 ,
  00111110000000000000000000011111 , 00011000111110000000000001111100 ,
  01111100000000000000000000111110 , 00010000111110000000000000111110 ,
  01111100000000000000000000111110 , 00110001111110000000000000111110 ,
  01111100000000000000000001111110 , 00110001111100000000000000111110 ,
  01111000000000000000000001111100 , 00100001111100011000000000011110 ,
  01111000000000000000000001111100 , 01100011111000010000000000011110 ,
  01111000000000000000000011111100 , 01000011111000010000000000011110 ,
  11111000000000000000000011111000 , 01000111111000110000000000011111 ,
  11111000000000000000000011111000 , 11000111110000100000000000011111 ,
  11111111111111111111111111111111 , 10000111110001111111111111111111 ,
  11111000000000000000001111110001 , 10001111110001100000000000011111 ,
  11111000000000000000000111110001 , 10001111100001000000000000011111 ,
  11111000000000000000001111100001 , 00001111100011000000000000011111 ,
  01111000000000000000001111100011 , 00011111100010000000000000011110 ,
  01111000000000000000011111100010 , 00011111000010000000000000011110 ,
  01111000000010000000011111000010 , 00011111000000000000000000011110 ,
  01111100011111000000011111000110 , 00111110000000000000000000111110 ,
  01111100011111000000111111000100 , 00111110000000000000000000111110 ,
  00111100011111100001111110000100 , 01111110000000000000000000111100 ,
  00111110011111111111111110001100 , 01111111111111111111000001111100 ,
  00111110001111111111111100001000 , 01111111111111111111000001111100 ,
  00011110000111111111111000011000 , 11111111111111111111000001111000 ,
  00011111000011111111110000011000 , 11111111111111111111000011111000 ,
  00011111000001111111000000100001 , 11111111111111111111000011110000 ,
  00001111100000000000000000110000 , 00000000000000000000000111110000 ,
  00001111110000000000000000100000 , 00000000000000000000001111110000 ,
  00000111110000000000000000100000 , 00000000000000000000001111100000 ,
  00000011111000000000000001100000 , 00000000000000000000011111000000 ,
  00000011111100000000000001000000 , 00000000000000000000111111000000 ,
  00000001111110000000000001000000 , 00000000000000000001111110000000 ,
  00000000111111000000000000000000 , 00000000000000000011111100000000 ,
  00000000011111100000000000000000 , 00000000000000000111111000000000 ,
  00000000001111111000000000000000 , 00000000000000011111110000000000 ,
  00000000000111111100000000000000 , 00000000000000111111100000000000 ,
  00000000000011111111000000000000 , 00000000000011111111000000000000 ,
  00000000000001111111111000000000 , 00000000011111111110000000000000 ,
  00000000000000011111111111000000 , 00000011111111111000000000000000 ,
  00000000000000001111111111111111 , 11111111111111110000000000000000 ,
  00000000000000000011111111111111 , 11111111111111000000000000000000 ,
  00000000000000000000011111111111 , 11111111111000000000000000000000 ,
  00000000000000000000000011111111 , 11111111000000000000000000000000 ,
  00000000000000000000000000000111 , 11100000000000000000000000000000 ,
decimal

: show-logo ( -- )  \ show the JeeLabs logo
  clear
  logo  OLED.LARGE 1+ 32 * 0 do
    64 0 do
      dup i 5 rshift cells + @
      i not $1F and rshift
      1 and if i 32 + j putpixel then
    loop
    8 +
  loop
  drop display ;

: lcd-init ( -- )  \ initialise the oled display
  i2c-init
  $AE lcd!c  \ DISPLAYOFF
  $A8 lcd!c  \ SETMULTIPLEX
   63 lcd!c
  $D3 lcd!c  \ SETDISPLAYOFFSET
    0 lcd!c
  $40 lcd!c  \ SETSTARTLINE
  $20 lcd!c  \ MEMORYMODE
  $00 lcd!c
  $21 lcd!c  \ SET COL ADDR
    0 lcd!c  \ COL START
  127 lcd!c  \ COL END
  $A1 lcd!c  \ SEGREMAP | 0x1
  $C8 lcd!c  \ COMSCANDEC
  $DA lcd!c  \ SETCOMPINS
  $12 lcd!c
  $81 lcd!c  \ SETCONTRAST
  $CF lcd!c
  $D9 lcd!c  \ SETPRECHARGE
  $F1 lcd!c
  $DB lcd!c  \ SETVCOMDETECT
  $40 lcd!c
  $2E lcd!c  \ STOP SCROLL
  $D5 lcd!c  \ SETDISPLAYCLOCKDIV
  $80 lcd!c
  $8D lcd!c  \ CHARGEPUMP
  $14 lcd!c  \ switched capacitor
  $A4 lcd!c  \ DISPLAYALLON_RESUME
  $A6 lcd!c  \ NORMALDISPLAY
  $AF lcd!c  \ DISPLAYON
;

\ lcd-init show-logo
